//------------------------------------------------------------------------------------------------------------------------------------------------------------------------
#include "Max44009.h"
#include <Wire.h>
//------------------------------------------------------------------------------------------------------------------------------------------------------------------------
// Max44009
//------------------------------------------------------------------------------------------------------------------------------------------------------------------------
Max44009::Max44009()
{
	
}
//------------------------------------------------------------------------------------------------------------------------------------------------------------------------
void Max44009::begin(MAX44009_ADDRESS addr)
{
	////////////Wire.begin();
	
	address = addr;
	
	Wire.beginTransmission(address);
	
	// выбираем регистр конфигурации
	Wire.write(0x02);
	// пишем в него - непрерывный режим измерения, время интегрирования - 800 ms
	Wire.write(0x40);
	
	Wire.endTransmission(true);	
     
}
//------------------------------------------------------------------------------------------------------------------------------------------------------------------------
float Max44009::readLuminosity()
{
     
	unsigned int data[2] = {0};

  Wire.beginTransmission(address);
  
  // регистр данных
  Wire.write(0x03);
  if(Wire.endTransmission(true) != 0)
    return -1.0;

  // ждём два байта
  if(Wire.requestFrom(address, 2) == 2)
  {
    data[0] = Wire.read();
    data[1] = Wire.read();
  }
  else
    return -1.0;

  // Convert the data to lux
  int exponent = (data[0] & 0xF0) >> 4;
  int mantissa = ((data[0] & 0x0F) << 4) | (data[1] & 0x0F);
  float luminosity = pow(2, exponent) * mantissa * 0.045;	 

  return luminosity;
	 
}
//------------------------------------------------------------------------------------------------------------------------------------------------------------------------
